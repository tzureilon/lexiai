# LexiAI

LexiAI היא פלטפורמת AI משפטית מלאה המשלבת שירות FastAPI פרודקשן-רדי ואפליקציית Next.js ארגונית לניהול ידע, חיזוי תיקים וציות פרטיות מקצה לקצה.

## מבנה הפרויקט

```
backend/   # שירות FastAPI המטפל בצ'אט, מסמכים וחיזוי הסתברויות
frontend/  # אפליקציית Next.js (מודלים מסוג Pages) עם Tailwind CSS
```

## הפעלת שירות ה-API

```bash
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn backend.main:app --reload
```

ברירת המחדל של בסיס הנתונים היא קובץ SQLite שנוצר בתיקיית `backend`, אך שכבת הנתונים החדשה מנהלת מיגרציות, סידור טבלאות ואינדקסים באופן אוטומטי באמצעות טבלת `schema_migrations` ודרייבר עם בריכות חיבורים. לפריסות ייצור ניתן לספק משתנה סביבה `DATABASE_URL` (למשל `postgresql://user:password@host:5432/lexiai`) – בעת עליית השירות כל הטבלאות, האינדקסים ובקרות השלמות יווצרו אוטומטית במסד הייעודי.

כדי להתחבר ל-PostgreSQL יש להתקין בסביבת ההפעלה את אחד מהדרייברים `psycopg` או `psycopg2-binary` ולהגדיר את ה-DSN. מומלץ להגדיר אסטרטגיית גיבויים ורפליקציה במסד המנוהל, להפעיל הצפנה במנוחה ולשמור את ההרשאות במנהל סודות (Vault/AWS Secrets Manager).

### תשתיות נתונים ושרידות

- ניתן להגדיר את סביבת ההרצה בעזרת `LEXIAI_ENVIRONMENT` (למשל `development`, `staging`, `production`). עבור התקנות SQLite ייווצר קובץ ייעודי לכל סביבה (`backend/lexiai_<environment>.db`).
- משתנה `LEXIAI_BACKUP_DIR` קובע היכן יישמרו קובצי הגיבוי. כברירת מחדל נוצרה תיקיית `backend/backups/<tenant>/<environment>/<type>`.
- בפריסות PostgreSQL יש להבטיח שפקודת `pg_dump` זמינה בנתיב או להגדיר `PG_DUMP_PATH`. קריאה ל-`POST /ops/backups` מפעילה גיבוי מלא, מחשבת checksum ומעדכנת את יומן האירועים והגיבויים עבור הדייר.
- טבלאות `data_backups` ו-`ops_events` מאפשרות מעקב אחר גיבויים, שחזורים ואירועי תפעול נוספים. ניתן לשלוף אותם דרך `GET /ops/backups` ו-`GET /ops/events`.

### Bootstrap ואימות משתמשים

1. הגדירו מפתח חתימה בטוח ותחום מותר לפני הרצת השירות. הערך חייב להכיל לפחות 32 תווים ואסור להשאיר את ברירת המחדל:

```bash
export LEXIAI_SECRET="סוד-ארוך-ומורכב-שלא-מאוחסן-בקוד"
export LEXIAI_ALLOWED_ORIGINS="http://localhost:3000"
```

   לחלופין ניתן להפנות את השירות לקובץ מנוהל באמצעות `LEXIAI_SECRET_FILE=/run/secrets/lexiai_secret`. סודות ישנים שנמצאים ברוטציה זמנית ניתן להוסיף דרך `LEXIAI_ADDITIONAL_SECRETS` או `LEXIAI_ADDITIONAL_SECRET_FILES`.

2. הפעילו את השירות ובצעו קריאה חד-פעמית ל-`POST /auth/bootstrap` עם מזהה דייר חדש, פרטי מנהל ראשי וסיסמה. נקודת הקצה מחזירה טוקן חתום שנשמר בטבלת `api_tokens`.

3. ניתן להפיק טוקנים נוספים (למשל למערכות חיצוניות) באמצעות `POST /auth/api-token` – הפעולה דורשת הרשאת `tenant:admin`.

4. כל בקשות ה-API חייבות לכלול כותרת `Authorization: Bearer <token>`; פניות ללא טוקן מאומת יידחו עם HTTP 401.

> העלאת מסמכים ויצירת גרסאות מתבצעות באמצעות בקשות JSON המקודדות Base64. הממשק הקדמי מטפל בכך אוטומטית, אך ניתן לבצע זאת ידנית עבור אינטגרציות חיצוניות.

## הפעלת הממשק הקדמי

```bash
cd frontend
npm install
npm run dev
```

ברירת המחדל של כתובת ה-API היא `http://localhost:8000`. ניתן להחליף אותה על ידי משתנה הסביבה `NEXT_PUBLIC_API_BASE_URL`. עם עליית הלקוח תופיע טופס התחברות אינטראקטיבי: הזינו את מזהה הדייר, כתובת הדוא"ל והסיסמה שנוצרו בשלב ה-bootstrap. לאחר ההתחברות הטוקן נשמר בצורה מוצפנת באחסון הדפדפן ומתווסף אוטומטית לבקשות.

> להחלפת משתמש ניתן ללחוץ על כפתור "התנתקות" במסך הבית או למחוק את אחסון ה-Session המקומי.

## בדיקות

```bash
cd backend
pytest
```

## יכולות נוכחיות

- **עוזר משפטי קונטקסטואלי** – צנרת RAG המחוברת ל-Claude (עם fallback היריסטי) שמחברת בין שאלת המשתמש, המסמכים והמאגר המשפטי ומחזירה תשובות עם ציון ביטחון והצלבות אסמכתאות.
- **אינטליגנציה למסמכים** – ניתוח ML משולב LLM המייצר תובנות, רציונלים, ניהול גרסאות מסמך, מדיניות שימור ותיוג רגישות לכל קובץ.
- **חיזוי תיקים מבוסס ML** – מודל הסתברותי מוסבר המפענח אותות טקסטואליים, מציג המלצות פעולה ומעדכן את יומן הבקרה הארגוני.
- **תכנון חקירת עדים** – מחולל אסטרטגיה ושאלות דינמיות עם בקרה על איכות ורפרנסים מתוך מסמכי הלקוח וממאגר הידע.
- **מרכז ציות ו-UX ארגוני** – ניהול בקשות פרטיות (GDPR/חוק הגנת הפרטיות), יומן פעילות מפורט, זרימות עבודה ומשימות צוות, הכל מתועד ביומני Audit נגישים ומופרד לפי דייר.
- **תשתית נתונים רב-דיירית** – כל נקודות הקצה מחייבות טוקן חתום עם `tenant_id`/`user_id`, שכבת הרשאות מאמתת בעלויות מסמך ומינימום חשיפה למסמכים רגישים, ובנוסף קיימות טבלאות לניהול גיבויים, אירועי תפעול ופרטי ריצות ML.
- **Pipeline ML מתמשך** – כל שיחה, חיזוי ותכנית חקירה נרשמים כ-Dataset Snapshot, ניתן לעקוב אחר ריצות אימון (`/ml/datasets`, `/ml/runs`) ולעדכן מדדי איכות לאורך זמן.
- **ניטור אינטגרציות LLM** – כשלי קריאות ל-LLM נרשמים בטבלת `llm_failures`, זמינים דרך `GET /llm/failures`, ומלווים באירועי תפעול (`/ops/events`) לצורך ניהול תקלות.

## חיבור למודלי שפה (Claude)

כדי להפעיל את היכולות המתקדמות יש להגדיר מפתח API של Anthropic לפני הרצת השרת:

```bash
export ANTHROPIC_API_KEY="sk-..."
# אופציונלי: בחירת מודל אחר ממשפחת Claude
export ANTHROPIC_MODEL="claude-3-5-sonnet-20240620"
```

בהיעדר מפתח תקף המערכת תמשיך לפעול באמצעות מודלים היריסטיים, אך התשובות יהיו בסיסיות יותר. לעולם אין לשמור את המפתח בקבצי קוד או במערכת בקרת הגרסאות.

## נקודות קצה מרכזיות לציות וניהול גרסאות

- `POST /documents/{id}/versions` – יצירת גרסה חדשה למסמך קיים עם הערת שינוי, tenant_id וזהות משתמש.
- `PATCH /documents/{id}` – עדכון מדיניות שימור ותיוג רגישות תוך תיעוד ביומן הפעילות והחלת בקרת מינימום חשיפה למסמכים רגישים.
- `POST /privacy/requests` – רישום בקשות משתמש (עיון/ייצוא/מחיקה) עם טיפול אוטומטי במחיקת מסמכים בהתאם ל-tenant.
- `GET /audit` – שליפת יומן הפעילות עם חובת ציון tenant וסינון לפי משתמש או פעולה.
- `POST /workflows/tasks` – יצירת משימות תפעול, כולל תאריכי יעד, תגיות ורישום Audit לכל שינוי עבור הדייר הנבחר.
